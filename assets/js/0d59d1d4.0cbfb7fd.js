(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{73:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return r})),n.d(t,"metadata",(function(){return l})),n.d(t,"toc",(function(){return d})),n.d(t,"default",(function(){return p}));var o=n(3),a=n(7),i=(n(0),n(112)),r={layout:"post",title:"Mangling Dynamic Language Symbols, Uniquely Addressing the Atoms of Hot-Reload"},l={permalink:"/blog/2021/05/20/mangling-dynamic-language-symbols",editUrl:"https://github.com/hydro-sdk/hydro-sdk.io/edit/main/blog/2021-05-20-mangling-dynamic-language-symbols.md",source:"@site/blog/2021-05-20-mangling-dynamic-language-symbols.md",title:"Mangling Dynamic Language Symbols, Uniquely Addressing the Atoms of Hot-Reload",description:"Decoupling the development time experience of Flutter from the Dart programming language.",date:"2021-05-20T00:00:00.000Z",formattedDate:"May 20, 2021",tags:[],readingTime:9.02,truncated:!1,nextItem:{title:"Expressing Inexpressible Constant Values",permalink:"/blog/expressing-inexpressible-constant-values"}},d=[{value:"Build Time",id:"build-time",children:[{value:"Mangling",id:"mangling",children:[]}]},{value:"Runtime",id:"runtime",children:[{value:"Pillars of Hot-Reload",id:"pillars-of-hot-reload",children:[]}]}],s={toc:d};function p(e){var t=e.components,n=Object(a.a)(e,["components"]);return Object(i.b)("wrapper",Object(o.a)({},s,n,{components:t,mdxType:"MDXLayout"}),Object(i.b)("p",null,"Decoupling the development time experience of Flutter from the Dart programming language.  "),Object(i.b)("p",null,Object(i.b)("a",{parentName:"p",href:"https://github.com/hydro-sdk/hydro-sdk"},"Hydro-SDK"),' is a project with one large, ambitious goal. "Become React Native for Flutter".',Object(i.b)("br",{parentName:"p"}),"\n","It aims to do that by:"),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},"Decoupling the API surface of Flutter from  the Dart programming language."),Object(i.b)("li",{parentName:"ol"},"Decoupling the development time experience of Flutter from the Dart programming language."),Object(i.b)("li",{parentName:"ol"},"Providing first-class support for over-the-air distribution of code."),Object(i.b)("li",{parentName:"ol"},"Providing an ecosystem of packages from ",Object(i.b)("inlineCode",{parentName:"li"},"pub.dev"),", automatically projected to supported languages and published to other package systems.")),Object(i.b)("p",null,"I wrote previously about the past and future of ",Object(i.b)("a",{parentName:"p",href:"https://github.com/hydro-sdk/hydro-sdk"},"Hydro-SDK")," ",Object(i.b)("a",{parentName:"p",href:"https://chgibb.github.io/one-year-of-hydro-sdk/"},"here"),". "),Object(i.b)("p",null,"In this article I want to delve into some of the gritty details of how Hydro-SDK compiles, manages and hot-reloads Typescript code."),Object(i.b)("p",null,Object(i.b)("inlineCode",{parentName:"p"},"ts2hc")," is a command line program distributed as part of each Hydro-SDK release. ",Object(i.b)("inlineCode",{parentName:"p"},"ts2hc"),"'s job is to turn Typescript code into bytecode and debug symbols. Users generally don't interact with it directly but rather indirectly through commands like ",Object(i.b)("inlineCode",{parentName:"p"},"hydroc build")," and ",Object(i.b)("inlineCode",{parentName:"p"},"hydroc run"),"."),Object(i.b)("h2",{id:"build-time"},"Build Time"),Object(i.b)("p",null,"Typescript is lowered into Lua by leveraging the excellent ",Object(i.b)("a",{parentName:"p",href:"https://github.com/TypeScriptToLua/TypeScriptToLua"},"Typescript to Lua (TSTL) library"),". Consider the following excerpt from the ",Object(i.b)("a",{parentName:"p",href:"https://github.com/hydro-sdk/counter-app"},"Counter-App showcase"),":"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-typescript"},'//counter-app/ota/lib/counterApp.ts\nimport {\n    //...\n    StatelessWidget,\n} from "@hydro-sdk/hydro-sdk/runtime/flutter/widgets/index";\nimport { \n    //...\n    MaterialApp, \n} from "@hydro-sdk/hydro-sdk/runtime/flutter/material/index";\nimport { Widget } from "@hydro-sdk/hydro-sdk/runtime/flutter/widget";\n\nexport class CounterApp extends StatelessWidget {\n    public constructor() {\n        super();\n    }\n\n    public build(): Widget {\n        return new MaterialApp({\n            title: "Counter App",\n            initialRoute: "/",\n            home: new MyHomePage("Counter App Home Page"),\n        });\n    }\n}\n')),Object(i.b)("p",null,Object(i.b)("inlineCode",{parentName:"p"},"ts2hc")," will lower ",Object(i.b)("inlineCode",{parentName:"p"},"counter-app/ota/lib/counterApp.ts"),", and all of its dependencies into individual Lua modules. These Lua modules are then bundled, with the result looking something like the following:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-lua"},'local package = {preload={}, loaded={}}\nlocal function require(file)\n    local loadedModule = package.loaded[file]\n    if loadedModule == nil\n    then\n        loadedModule = package.preload[file]()\n        package.loaded[file] = loadedModule\n        return loadedModule\n    end\n    return loadedModule\nend\n-- ...\npackage.preload["ota.lib.counterApp"] = (function (...)\n    require("lualib_bundle");\n    local ____exports = {}\n    local ____index = require("ota.@hydro-sdk.hydro-sdk.runtime.flutter.widgets.index")\n    -- ...\n    local StatelessWidget = ____index.StatelessWidget\n\n    -- ...\n    local ____index = require("ota.@hydro-sdk.hydro-sdk.runtime.flutter.material.index")\n    local MaterialApp = ____index.MaterialApp\n\n    ____exports.CounterApp = __TS__Class()\n\n    local CounterApp = ____exports.CounterApp\n\n    CounterApp.name = "CounterApp"\n\n    __TS__ClassExtends(CounterApp, StatelessWidget)\n\n    function CounterApp.prototype.____constructor(self)\n        StatelessWidget.prototype.____constructor(self)\n    end\n\n    function CounterApp.prototype.build(self)\n        return __TS__New(\n            MaterialApp,\n            {\n                title = "Counter App",\n                initialRoute = "/",\n                home = __TS__New(MyHomePage, "Counter App Home Page")\n            }\n        )\n    end\n\n    return ____exports\n\nend)\n')),Object(i.b)("p",null,"The lowered and bundled Lua still somewhat resembles the input Typescript. Typescript ES6 modules are wrapped into Lua immediately invoked function expressions (IIFE), assigned string keys in the ",Object(i.b)("inlineCode",{parentName:"p"},"package.preload")," map and their ",Object(i.b)("inlineCode",{parentName:"p"},"exports")," made available by ",Object(i.b)("inlineCode",{parentName:"p"},"require"),"ing them. This pattern should be familiar to anyone who's hacked on Javascript bundlers/module resolvers like Browserify or Rollup."),Object(i.b)("p",null,"Lua lacks builtin object-oriented programming (OOP) facilities (whether prototypal or otherwise). Typescript language features which don't quite map one-to-one with Lua are shimmed using ",Object(i.b)("inlineCode",{parentName:"p"},"__TS_*")," functions made available through the ",Object(i.b)("inlineCode",{parentName:"p"},"lualib_bundle")," module (which ",Object(i.b)("inlineCode",{parentName:"p"},"ts2hc")," injects during bundling). Above, the ",Object(i.b)("inlineCode",{parentName:"p"},"CounterApp")," class is lowered into a series of calls to ",Object(i.b)("inlineCode",{parentName:"p"},"__TS__Class")," and ",Object(i.b)("inlineCode",{parentName:"p"},"__TS__ClassExtends"),", followed by placing its declared methods on its ",Object(i.b)("inlineCode",{parentName:"p"},"prototype"),"."),Object(i.b)("p",null,"The Lua bundle output by ",Object(i.b)("inlineCode",{parentName:"p"},"ts2hc")," will eventually be turned into bytecode by the PUC-RIO Lua 5.2 compiler, distributed under the name ",Object(i.b)("inlineCode",{parentName:"p"},"luac52")," by Hydro-SDK. The ",Object(i.b)("inlineCode",{parentName:"p"},"build")," method on the ",Object(i.b)("inlineCode",{parentName:"p"},"CounterApp")," class above would compile into something like the following:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"1   GETTABUP    1 0 -1  \n2   GETUPVAL    2 1 \n3   NEWTABLE    3 0 1   \n4   GETTABUP    4 0 -1\n5   GETUPVAL    5 2 \n6   CALL        4 2 2   \n7   SETTABLE    3 -2 4\n8   TAILCALL    1 3 0   \n9   RETURN      1 0 \n10  RETURN      0 1\n")),Object(i.b)("p",null,"Lua bytecode is outside the scope of this article, though is mentioned here for completeness."),Object(i.b)("h3",{id:"mangling"},"Mangling"),Object(i.b)("p",null,"In addition to lowering, ",Object(i.b)("inlineCode",{parentName:"p"},"ts2hc")," also undertakes an analysis pass of each output Lua module to discover its functions."),Object(i.b)("p",null,"From the above example, ",Object(i.b)("inlineCode",{parentName:"p"},"ts2hc")," will record the following functions:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"CounterApp.prototype.____constructor\nCounterApp.prototype.build\n")),Object(i.b)("p",null,"corresponding to the constructor and ",Object(i.b)("inlineCode",{parentName:"p"},"build")," method declarations of the original ",Object(i.b)("inlineCode",{parentName:"p"},"CounterApp")," class. These names are obviously captured from the original declaration names. For cases like our example (where clear function names where given), this works well enough."),Object(i.b)("p",null,Object(i.b)("inlineCode",{parentName:"p"},"ts2hc")," cannot rely on the programmer giving it clear and comprehensible function names however. ",Object(i.b)("inlineCode",{parentName:"p"},"ts2hc")," takes the original symbol names from the output Lua module and performs ",Object(i.b)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Name_mangling#Name_mangling_in_C.2B.2B"},"name mangling"),". The intent of name mangling is to uniquely identify a given function, no matter where or how it was declared. ",Object(i.b)("inlineCode",{parentName:"p"},"ts2hc"),"'s name mangling approach is heavily inspired by the IA-64 Itanium C++ ABI as well as Rust's name mangling approach. Whereas those two approaches rely heavily on type-information to produce their mangled names, Lua is a dynamic and un-typed language and offers no such convenience. ",Object(i.b)("inlineCode",{parentName:"p"},"ts2hc")," first considers the names and declaration order of function arguments resulting in the following:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"CounterApp.prototype.____constructor::self\nCounterApp.prototype.build::self\n")),Object(i.b)("p",null,"That is not quite enough information to uniquely identify a function however. ",Object(i.b)("inlineCode",{parentName:"p"},"ts2hc")," further considers the hash of the Typescript filename, and a disambiguation index suffix to resolve mangled name conflicts by declaration order resulting in the following: "),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"_Lae3eafcf842016833530caebe7755167b0866b5ac96416b45848c6fc6d65c58f::CounterApp.prototype.____constructor::self::0\n_Lae3eafcf842016833530caebe7755167b0866b5ac96416b45848c6fc6d65c58f::CounterApp.prototype.build::self::0    \n")),Object(i.b)("p",null,"This form works perfectly for functions that are named by the programmer like class methods or free functions. Consider however if the ",Object(i.b)("inlineCode",{parentName:"p"},"build")," method on the ",Object(i.b)("inlineCode",{parentName:"p"},"CounterApp")," class were written to have an anonymous closure:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-typescript"},'public build(): Widget {\n        return new MaterialApp({\n            title: "Counter App",\n            initialRoute: "/",\n            home: (() => new MyHomePage("Counter App Home Page"))(),\n        });\n    }\n')),Object(i.b)("p",null,"For anonymous closures, ",Object(i.b)("inlineCode",{parentName:"p"},"ts2hc"),' simply names them "anonymous',Object(i.b)("em",{parentName:"p"},'closure". In order to uniquely identify anonymous closures (or any nested function declarations), a ',"[dominator analysis]","(",Object(i.b)("a",{parentName:"em",href:"https://en.wikipedia.org/wiki/Dominator"},"https://en.wikipedia.org/wiki/Dominator")),"(graph_theory)) with respect to the declaration order of every function is performed. The mangled name of the immediate dominator as well as the mangled names of every member of the dominance frontier of each function are prefixed to its mangled name. For the anonymous closure in the example above, it results in the following mangled name:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"_Lae3eafcf842016833530caebe7755167b0866b5ac96416b45848c6fc6d65c58f::CounterApp.prototype.build::self::0::anonymous_closure::0\n")),Object(i.b)("p",null,"This form encodes enough information to uniquely identify a function. ",Object(i.b)("inlineCode",{parentName:"p"},"ts2hc")," will join each functions mangled name with information like the line/column numbers in the original Typescript file, the line/column numbers in the Lua module the original Typescript file was lowered into, the line/column numbers the function ended up in in the final Lua bundle and other information into a single debug symbol. These debug symbols are what power function maps, provide readable stack traces as well as hot-reload. "),Object(i.b)("h2",{id:"runtime"},"Runtime"),Object(i.b)("p",null,"Common Flutter Runtime (CFR) is a blanket term given to the Lua 5.2 virtual machine, binding system and other libraries at the core of Hydro-SDK's runtime environment. Users generally don't interact with the CFR directly, but rather through widgets like ",Object(i.b)("inlineCode",{parentName:"p"},"RunComponent")," and ",Object(i.b)("inlineCode",{parentName:"p"},"RunComponentFromFile"),"."),Object(i.b)("p",null,Object(i.b)("inlineCode",{parentName:"p"},"ts2hc")," and CFR are at the very core of the developer experience and runtime system of Hydro-SDK. They work together to support goal 2 above by providing an analog to Flutter's killer development-time feature; hot-reload."),Object(i.b)("h3",{id:"pillars-of-hot-reload"},"Pillars of Hot-Reload"),Object(i.b)("p",null,"In Flutter, hot-reload is provided by Dart VM. Dart VM's hot-reload is based on a few ",Object(i.b)("a",{parentName:"p",href:"https://github.com/dart-lang/sdk/wiki/Hot-reload#immutable-methods"},"pillars"),":"),Object(i.b)("p",null,"Pervasive Late-Binding"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"The program behaves as if method lookup happens at every call")),Object(i.b)("p",null,"Immutable Methods"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},'The "atoms" of reload are methods. Methods are never mutated. Changes to a method declaration create a new method, mutating the class or library\'s method dictionary. The old method may still exist if it has been captured by a closure or stack frame.'),Object(i.b)("li",{parentName:"ul"},"Closures capture their function when they are created. A closure always has the same function before and after a change, and all invocations of a given closure run the same function.")),Object(i.b)("p",null,"State is Retained"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"Hot reload does not reset fields, neither the fields of instances nor those of classes or libraries")),Object(i.b)("p",null,'CFR\'s hot-reload is inspired by (and largely abides by) the same pillars. CFR diverges from Dart VM however on the "Immutable Methods" pillar. In CFR, closures (and their scopes) are refreshed prior to every invocation. This means that old functions can never be invoked after a hot-reload no matter if they were captured by a closure. The only exception to this is if an old function is a stack frame. CFR uses the mangled name of debug symbols provided to it by ',Object(i.b)("inlineCode",{parentName:"p"},"ts2hc")," to uniquely address functions, allowing it to perform just-in-time method lookups and late-binding in a manner similar to Dart VM."),Object(i.b)("p",null,"Consider the ",Object(i.b)("inlineCode",{parentName:"p"},"build")," method of the ",Object(i.b)("inlineCode",{parentName:"p"},"MyHomePageState")," class from the ",Object(i.b)("a",{parentName:"p",href:"https://github.com/hydro-sdk/counter-app"},"Counter-App showcase"),":"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-typescript"},'import {\n    Text,\n    Center,\n    StatefulWidget,\n    State,\n    Column,\n    MainAxisAlignment,\n    Icon,\n} from "@hydro-sdk/hydro-sdk/runtime/flutter/widgets/index";\nimport { AppBar, FloatingActionButton, Icons, Scaffold, Theme } from "@hydro-sdk/hydro-sdk/runtime/flutter/material/index";\nimport { Widget } from "@hydro-sdk/hydro-sdk/runtime/flutter/widget";\nimport { BuildContext } from "@hydro-sdk/hydro-sdk/runtime/flutter/buildContext";\nimport { Key } from "@hydro-sdk/hydro-sdk/runtime/flutter/foundation/key";\n//...\npublic build(context: BuildContext): Widget {\n        return new Scaffold({\n            appBar: new AppBar({\n                title: new Text(this.title),\n            }),\n            body: new Center({\n                child: new Column({\n                    mainAxisAlignment: MainAxisAlignment.center,\n                    children: [\n                        new Text("You have pushed the button this many times"),\n                        new Text(this.counter.toString(), {\n                            key: new Key("counter"),\n                            style: Theme.of(context).textTheme.display1,\n                        }),\n                    ],\n                }),\n            }),\n            floatingActionButton: new FloatingActionButton({\n                key: new Key("increment"),\n                child: new Icon(Icons.add),\n                onPressed: this.incrementCounter,\n            }),\n        });\n    }\n')),Object(i.b)("p",null,'Making simple additions or deletions like changing the string "You have pushed the button this many times" to something else or adding more ',Object(i.b)("inlineCode",{parentName:"p"},"Text")," widgets results in successful hot-reloads and no change in app state."),Object(i.b)("p",null,"Consider a change to the original ",Object(i.b)("inlineCode",{parentName:"p"},"build")," method to the following:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-typescript"},'import {\n    Text,\n    Center,\n    StatefulWidget,\n    State,\n    Column,\n    MainAxisAlignment,\n    Icon,\n    Container,\n    MediaQuery\n} from "@hydro-sdk/hydro-sdk/runtime/flutter/widgets/index";\nimport { Colors, FloatingActionButton, Icons, MaterialApp, Scaffold, Theme } from "@hydro-sdk/hydro-sdk/runtime/flutter/material/index";\nimport { Widget } from "@hydro-sdk/hydro-sdk/runtime/flutter/widget";\nimport { BuildContext } from "@hydro-sdk/hydro-sdk/runtime/flutter/buildContext";\nimport { Key } from "@hydro-sdk/hydro-sdk/runtime/flutter/foundation/key";\n//...\npublic build(context: BuildContext): Widget {\n        return new Scaffold({\n            appBar: new AppBar({\n                title: new Text(this.title),\n            }),\n            body: new Center({\n                child: new Column({\n                    mainAxisAlignment: MainAxisAlignment.center,\n                    children: [\n                        //Add a thin blue box on top of the counter text\n                        new Container({\n                            color: Colors.blue.swatch[100],\n                            height: 25,\n                            width: MediaQuery.of(context).size.getWidth(),\n                        }),\n                        new Text("You have pushed the button this many times"),\n                        new Text(this.counter.toString(), {\n                            key: new Key("counter"),\n                            style: Theme.of(context).textTheme.display1,\n                        }),\n                    ],\n                }),\n            }),\n            floatingActionButton: new FloatingActionButton({\n                key: new Key("increment"),\n                child: new Icon(Icons.add),\n                onPressed: this.incrementCounter,\n            }),\n        });\n    }\n')),Object(i.b)("p",null,"The above change will result in an error like the following:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"attempt to index a nil value null swatch\nError raised in: \n  MyHomePageState.prototype.build\n     defined in counter-app/ota/lib/counterApp.ts:63\nVM stacktrace follows:\n@.hydroc/0.0.1-nightly.231/ts2hc/40bd309e7516dae86ac3d02346f6d3a9b20fa010a9da4e6e3a65a33420bb9d32/index.ts:11563\n  (_Lae3eafcf842016833530caebe7755167b0866b5ac96416b45848c6fc6d65c58f::MyHomePageState.prototype.build::self_context::0)\nDart stacktrace follows:\n#0      Context.tableIndex package:hydro_sdk/\u2026/vm/context.dart:135\n#1      gettable           package:hydro_sdk/\u2026/instructions/gettable.dart:12\n#2      Frame.cont         package:hydro_sdk/\u2026/vm/frame.dart:228\n#3      Closure._dispatch  package:hydro_sdk/\u2026/vm/closure.dart:96\n#4      Closure.dispatch   package:hydro_sdk/\u2026/vm/closure.dart:69\n...\n")),Object(i.b)("p",null,"This error is the result of ",Object(i.b)("inlineCode",{parentName:"p"},"Colors.blue.swatch")," being uninitialized. Recall the example Lua module output above. Imported symbols are assigned to the value of calls to ",Object(i.b)("inlineCode",{parentName:"p"},"require"),". The ",Object(i.b)("inlineCode",{parentName:"p"},"build")," method now closes over symbols that are uninitialized (the newly imported symbols). This is unfortunately an artifact of how Typescript modules are represented when lowered. The result is that referencing newly imported symbols in a hot-reloaded function will usually trigger an exception."),Object(i.b)("p",null,"Hot-reload in Hydro-SDK is implemented purely in terms of Lua. Support for hot-reloading other programming languages (like Haxe and C#) in Hydro-SDK should not suffer from this same limitation (though will probably come with their own challenges and limitations)."))}p.isMDXComponent=!0}}]);